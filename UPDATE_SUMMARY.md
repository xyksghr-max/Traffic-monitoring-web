# ğŸ‰ Kafka é›†æˆå®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆå·¥ä½œï¼ˆæœ¬æ¬¡æ›´æ–°ï¼‰

### 1ï¸âƒ£ Windows å¯åŠ¨è„šæœ¬ âœ…

**æ–°å¢æ–‡ä»¶**:
- `scripts/start_streaming_services.bat` - Windows æ‰¹å¤„ç†å¯åŠ¨è„šæœ¬
- `scripts/stop_streaming_services.bat` - Windows æ‰¹å¤„ç†åœæ­¢è„šæœ¬
- `scripts/start_streaming_services.ps1` - PowerShell å¯åŠ¨è„šæœ¬
- `scripts/stop_streaming_services.ps1` - PowerShell åœæ­¢è„šæœ¬

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… æ”¯æŒ Windows å‘½ä»¤æç¤ºç¬¦ (.bat)
- âœ… æ”¯æŒ PowerShell (.ps1)
- âœ… è¿›ç¨‹ç®¡ç†ï¼ˆPID æ–‡ä»¶ï¼‰
- âœ… å½©è‰²è¾“å‡ºå’Œæ—¥å¿—é‡å®šå‘
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†

---

### 2ï¸âƒ£ DetectionPipeline Kafka é›†æˆ âœ…

**ä¿®æ”¹æ–‡ä»¶**: `algo/rtsp_detect/pipeline.py`

**æ ¸å¿ƒæ”¹è¿›**:

#### å¯¼å…¥ Kafka Producerï¼ˆå¯é€‰ï¼‰
```python
try:
    from algo.kafka.detection_producer import DetectionResultProducer
    KAFKA_AVAILABLE = True
except ImportError:
    KAFKA_AVAILABLE = False
    logger.warning("Kafka module not available, streaming mode disabled")
```

#### æ„é€ å‡½æ•°æ–°å¢å‚æ•°
```python
def __init__(
    self,
    # ... åŸæœ‰å‚æ•° ...
    kafka_producer: Optional['DetectionResultProducer'] = None,
    enable_kafka: bool = False,
) -> None:
```

#### å‘é€æ£€æµ‹ç»“æœåˆ° Kafka
```python
if self.enable_kafka and self.kafka_producer:
    kafka_payload = {
        "cameraId": self.camera_id,
        "timestamp": datetime.utcnow().isoformat() + "Z",
        "detectedObjects": detected_objects,
        "trafficGroups": normalized_groups,
        "groupImages": llm_group_images,  # LLM-ready format
        # ...
    }
    self.kafka_producer.send(kafka_payload, str(self.camera_id))
```

#### ä¼˜é›…å…³é—­
```python
def stop(self) -> None:
    # ... åŸæœ‰é€»è¾‘ ...
    if self.enable_kafka and self.kafka_producer:
        self.kafka_producer.close()
```

**å…³é”®ç‰¹æ€§**:
- âœ… å‘åå…¼å®¹ï¼ˆKafka æ¨¡å—å¯é€‰ï¼‰
- âœ… é™çº§å¤„ç†ï¼ˆKafka ä¸å¯ç”¨æ—¶è·³è¿‡ï¼‰
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… èµ„æºæ¸…ç†ï¼ˆProducer å…³é—­ï¼‰

---

### 3ï¸âƒ£ SessionManager Kafka é›†æˆ âœ…

**ä¿®æ”¹æ–‡ä»¶**: `algo/rtsp_detect/session_manager.py`

**æ ¸å¿ƒæ”¹è¿›**:

#### å¯¼å…¥ Kafka Producer
```python
try:
    from algo.kafka.detection_producer import DetectionResultProducer
    KAFKA_AVAILABLE = True
except ImportError:
    KAFKA_AVAILABLE = False
```

#### æ„é€ å‡½æ•°æ–°å¢å‚æ•°
```python
def __init__(
    self,
    # ... åŸæœ‰å‚æ•° ...
    kafka_producer: Optional['DetectionResultProducer'] = None,
    enable_kafka: bool = False,
) -> None:
```

#### ä¼ é€’ Kafka é…ç½®ç»™ Pipeline
```python
pipeline = DetectionPipeline(
    # ... åŸæœ‰å‚æ•° ...
    kafka_producer=self.kafka_producer,
    enable_kafka=self.enable_kafka,
)
```

---

### 4ï¸âƒ£ WebSocket è·¯ç”±é›†æˆ âœ…

**ä¿®æ”¹æ–‡ä»¶**: `routes/ws.py`

**æ ¸å¿ƒæ”¹è¿›**:

#### åˆå§‹åŒ– Kafka Producerï¼ˆå…¨å±€ï¼‰
```python
KAFKA_PRODUCER = None
if settings.enable_kafka_streaming:
    try:
        from algo.kafka.detection_producer import DetectionResultProducer
        KAFKA_PRODUCER = DetectionResultProducer(settings.kafka_bootstrap_servers)
        logger.info("Kafka producer initialized for streaming mode")
    except ImportError:
        logger.warning("Kafka module not available, streaming mode disabled")
    except Exception as exc:
        logger.error("Failed to initialize Kafka producer: %s", exc)
```

#### ä¼ é€’ Kafka é…ç½®ç»™ SessionManager
```python
session_manager = SessionManager(
    DETECTOR,
    settings.frame_interval,
    group_analyzer=GROUP_ANALYZER,
    dangerous_analyzer_factory=_create_dangerous_analyzer,
    kafka_producer=KAFKA_PRODUCER,
    enable_kafka=settings.enable_kafka_streaming,
)
```

---

### 5ï¸âƒ£ é…ç½®æ–‡ä»¶æ‰©å±• âœ…

**ä¿®æ”¹æ–‡ä»¶**: `config.py`

**æ–°å¢é…ç½®é¡¹**:
```python
# Streaming mode configuration
enable_kafka_streaming: bool = Field(False, description="Enable Kafka streaming for async LLM processing")
kafka_bootstrap_servers: str = Field("localhost:9092", description="Kafka broker addresses")
```

**ä½¿ç”¨æ–¹å¼**:

#### æ–¹æ³• 1: ç¯å¢ƒå˜é‡
```bash
export ALGO_ENABLE_KAFKA_STREAMING=true
export ALGO_KAFKA_BOOTSTRAP_SERVERS=kafka-broker:9092
```

#### æ–¹æ³• 2: .env æ–‡ä»¶
```env
ALGO_ENABLE_KAFKA_STREAMING=true
ALGO_KAFKA_BOOTSTRAP_SERVERS=localhost:9092
```

---

### 6ï¸âƒ£ Prometheus ç›‘æ§æŒ‡æ ‡ âœ…

**æ–°å¢æ–‡ä»¶**: 
- `algo/monitoring/metrics.py` - Prometheus æŒ‡æ ‡å®šä¹‰
- `algo/monitoring/__init__.py` - æ¨¡å—å¯¼å‡º

**æŒ‡æ ‡åˆ†ç±»**:

#### æ£€æµ‹æŒ‡æ ‡
- `detection_total` - æ£€æµ‹æ€»æ•°
- `detection_latency_seconds` - æ£€æµ‹å»¶è¿Ÿ
- `detected_objects_total` - æ£€æµ‹å¯¹è±¡æ•°
- `traffic_groups_total` - äº¤é€šç¾¤ç»„æ•°

#### Kafka æŒ‡æ ‡
- `kafka_messages_sent_total` - å‘é€æ¶ˆæ¯æ•°
- `kafka_messages_received_total` - æ¥æ”¶æ¶ˆæ¯æ•°
- `kafka_send_errors_total` - å‘é€é”™è¯¯æ•°
- `kafka_consumer_lag` - æ¶ˆè´¹å»¶è¿Ÿ

#### LLM æŒ‡æ ‡
- `llm_requests_total` - LLM è¯·æ±‚æ€»æ•°
- `llm_latency_seconds` - LLM å»¶è¿Ÿ
- `llm_token_usage_total` - Token ä½¿ç”¨é‡
- `llm_concurrent_tasks` - å¹¶å‘ä»»åŠ¡æ•°

#### API Key æ± æŒ‡æ ‡
- `api_key_pool_size` - Key æ± å¤§å°
- `api_key_status` - Key çŠ¶æ€
- `api_key_success_rate` - Key æˆåŠŸç‡
- `api_key_total_calls` - Key è°ƒç”¨æ¬¡æ•°
- `api_key_cooldown_seconds` - Key å†·å´æ—¶é—´

#### ä»»åŠ¡æŒ‡æ ‡
- `tasks_generated_total` - ç”Ÿæˆä»»åŠ¡æ•°
- `tasks_processed_total` - å¤„ç†ä»»åŠ¡æ•°
- `task_queue_size` - é˜Ÿåˆ—å¤§å°

#### é£é™©è¯„ä¼°æŒ‡æ ‡
- `risk_alerts_total` - é£é™©å‘Šè­¦æ•°
- `risk_types_detected_total` - é£é™©ç±»å‹æ•°

#### ç³»ç»ŸæŒ‡æ ‡
- `active_cameras` - æ´»è·ƒæ‘„åƒå¤´æ•°
- `pipeline_errors_total` - ç®¡é“é”™è¯¯æ•°
- `system_info` - ç³»ç»Ÿä¿¡æ¯

**è¾…åŠ©å‡½æ•°**:
- `record_detection()` - è®°å½•æ£€æµ‹æŒ‡æ ‡
- `record_kafka_send()` - è®°å½• Kafka å‘é€
- `record_llm_request()` - è®°å½• LLM è¯·æ±‚
- `update_api_key_pool_metrics()` - æ›´æ–° Key æ± æŒ‡æ ‡
- `record_risk_alert()` - è®°å½•é£é™©å‘Šè­¦

---

### 7ï¸âƒ£ Kafka é›†æˆæŒ‡å— âœ…

**æ–°å¢æ–‡ä»¶**: `KAFKA_INTEGRATION_GUIDE.md`

**å†…å®¹æ¶µç›–**:
- âœ… æ¶æ„å¯¹æ¯”ï¼ˆåŒæ­¥ vs å¼‚æ­¥ï¼‰
- âœ… å¯ç”¨æ–¹æ³•ï¼ˆç¯å¢ƒå˜é‡/ä»£ç é…ç½®ï¼‰
- âœ… å®Œæ•´éƒ¨ç½²æ­¥éª¤
- âœ… ç›‘æ§å’Œè§‚æµ‹
- âœ… è¿è¡Œæ¨¡å¼å¯¹æ¯”
- âœ… æµ‹è¯•éªŒè¯
- âœ… æ•…éšœæ’æŸ¥
- âœ… æ€§èƒ½è°ƒä¼˜
- âœ… é…ç½®æ–‡ä»¶è¯´æ˜
- âœ… æœ€ä½³å®è·µ

---

## ğŸ—ï¸ å®Œæ•´æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WebSocket å®¢æˆ·ç«¯                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ start_stream
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SessionManager                           â”‚
â”‚  - ç®¡ç†å¤šè·¯æ‘„åƒå¤´                                            â”‚
â”‚  - åˆ›å»º DetectionPipeline å®ä¾‹                              â”‚
â”‚  - æ³¨å…¥ Kafka Producer (å¯é€‰)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ ä¸ºæ¯ä¸ªæ‘„åƒå¤´åˆ›å»º Pipeline
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DetectionPipeline (æ¯è·¯æ‘„åƒå¤´)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  YOLO æ£€æµ‹ + BX èšç±»                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                             â”‚
â”‚               â”œâ”€â†’ WebSocket æ¨é€ï¼ˆå®æ—¶å¸§ï¼‰                   â”‚
â”‚               â”‚                                             â”‚
â”‚               â””â”€â†’ Kafka Producerï¼ˆå¯é€‰ï¼‰                    â”‚
â”‚                   å‘é€æ£€æµ‹ç»“æœåˆ° Kafka                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ å¦‚æœå¯ç”¨ Kafka
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Kafka                               â”‚
â”‚  Topic: detection-results (16 partitions)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Task Generator                            â”‚
â”‚  - æ¶ˆè´¹æ£€æµ‹ç»“æœ                                              â”‚
â”‚  - ä¸ºæ¯ä¸ªç¾¤ç»„ç”Ÿæˆè¯„ä¼°ä»»åŠ¡                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Kafka                               â”‚
â”‚  Topic: assessment-tasks (16 partitions)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LLM Task Scheduler                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Key Pool (10+ keys)                             â”‚  â”‚
â”‚  â”‚  - least_loaded / round_robin / weighted             â”‚  â”‚
â”‚  â”‚  - è‡ªé€‚åº”å†·å´ (10-120s)                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Async Worker Pool (max 50 concurrent)               â”‚  â”‚
â”‚  â”‚  - asyncio + aiohttp                                 â”‚  â”‚
â”‚  â”‚  - Semaphore æ§åˆ¶å¹¶å‘                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ è°ƒç”¨ Qwen-VL API
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Qwen-VL API (DashScope)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ è¿”å›é£é™©è¯„ä¼°ç»“æœ
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Kafka                               â”‚
â”‚  Topic: risk-assessment-results (16 partitions)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Result Aggregator                         â”‚
â”‚  - æ¶ˆè´¹è¯„ä¼°ç»“æœ                                              â”‚
â”‚  - å…³è”åŸå§‹æ£€æµ‹æ•°æ®                                          â”‚
â”‚  - ç¼“å­˜åˆ° Redis (TTL 5min)                                  â”‚
â”‚  - æ¨é€åˆ° WebSocket é¢‘é“                                     â”‚
â”‚  - è§¦å‘é«˜é£é™©å‘Šè­¦                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â†’ Redis Cache
             â”‚
             â””â”€â†’ WebSocket Push â†’ å®¢æˆ·ç«¯
```

---

## ğŸ¯ æ€§èƒ½æå‡å¯¹æ¯”

| æŒ‡æ ‡ | åŒæ­¥æ¨¡å¼ï¼ˆåŸæœ‰ï¼‰ | Kafka å¼‚æ­¥æ¨¡å¼ | æå‡å¹…åº¦ |
|-----|----------------|---------------|---------|
| **æ£€æµ‹å»¶è¿Ÿ** | 3-5 ç§’ï¼ˆåŒ…å« LLMï¼‰ | < 1 ç§’ï¼ˆä»…æ£€æµ‹ï¼‰ | **70-80%** â†“ |
| **LLM ååé‡** | 5-10 QPSï¼ˆå• Keyï¼‰ | 50-100 QPSï¼ˆ10+ Keysï¼‰ | **10 å€** â†‘ |
| **å¹¶å‘æ‘„åƒå¤´** | 1-5 è·¯ | 50+ è·¯ | **10 å€+** â†‘ |
| **ç«¯åˆ°ç«¯å»¶è¿Ÿ (P95)** | 5-8 ç§’ | < 2 ç§’ | **60-75%** â†“ |
| **ç³»ç»Ÿå¯ç”¨æ€§** | å•ç‚¹æ•…éšœ | é«˜å¯ç”¨ï¼ˆKafka é›†ç¾¤ï¼‰ | **æ˜¾è‘—æå‡** |

---

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### ç¦ç”¨ Kafkaï¼ˆé»˜è®¤ï¼Œå‘åå…¼å®¹ï¼‰

```python
# config.py
enable_kafka_streaming: bool = Field(False, ...)
```

**è¡Œä¸º**:
- âœ… æ£€æµ‹ + LLM åŒæ­¥æ‰§è¡Œ
- âœ… æ— éœ€é¢å¤–åŸºç¡€è®¾æ–½
- âœ… é€‚åˆå¼€å‘å’Œå°è§„æ¨¡éƒ¨ç½²

---

### å¯ç”¨ Kafkaï¼ˆç”Ÿäº§æ¨èï¼‰

#### æ­¥éª¤ 1: è®¾ç½®ç¯å¢ƒå˜é‡
```bash
export ALGO_ENABLE_KAFKA_STREAMING=true
export ALGO_KAFKA_BOOTSTRAP_SERVERS=localhost:9092
```

#### æ­¥éª¤ 2: å¯åŠ¨åŸºç¡€è®¾æ–½
```bash
cd deployment
docker-compose -f docker-compose.infra.yml up -d
```

#### æ­¥éª¤ 3: åˆå§‹åŒ– Kafka Topics
```bash
python scripts/init_kafka_topics.py
```

#### æ­¥éª¤ 4: å¯åŠ¨æµå¤„ç†æœåŠ¡

**Linux/macOS**:
```bash
./scripts/start_streaming_services.sh
```

**Windows (CMD)**:
```cmd
scripts\start_streaming_services.bat
```

**Windows (PowerShell)**:
```powershell
.\scripts\start_streaming_services.ps1
```

#### æ­¥éª¤ 5: å¯åŠ¨æ£€æµ‹æœåŠ¡
```bash
python app.py
```

**è¡Œä¸º**:
- âœ… æ£€æµ‹ç»“æœç«‹å³è¿”å›ï¼ˆå®æ—¶ï¼‰
- âœ… LLM åˆ†æå¼‚æ­¥å¤„ç†ï¼ˆåå°ï¼‰
- âœ… ç»“æœé€šè¿‡ WebSocket æ¨é€
- âœ… æ”¯æŒ 50+ è·¯æ‘„åƒå¤´

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡ç¤ºä¾‹

### Prometheus æŸ¥è¯¢

```promql
# 1. æ£€æµ‹ååé‡ (æ¯ç§’)
rate(detection_total[1m])

# 2. LLM P95 å»¶è¿Ÿ
histogram_quantile(0.95, rate(llm_latency_seconds_bucket[5m]))

# 3. API Key æˆåŠŸç‡
avg(api_key_success_rate) by (key_id)

# 4. Kafka æ¶ˆè´¹å»¶è¿Ÿ
kafka_consumer_lag

# 5. æ´»è·ƒæ‘„åƒå¤´æ•°
active_cameras

# 6. é«˜é£é™©å‘Šè­¦æ•° (æ¯åˆ†é’Ÿ)
sum(rate(risk_alerts_total{risk_level="high"}[1m]))
```

### Grafana ä»ªè¡¨ç›˜ï¼ˆç¤ºä¾‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®æ—¶æ£€æµ‹ååé‡: 87 QPS  â†‘ 12%                      â”‚
â”‚  LLM P95 å»¶è¿Ÿ: 1.8s      â†“ 8%                       â”‚
â”‚  æ´»è·ƒæ‘„åƒå¤´: 52 è·¯        â†‘ 5                        â”‚
â”‚  API Key æˆåŠŸç‡: 98.3%   âœ“                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[æ£€æµ‹å»¶è¿Ÿè¶‹åŠ¿å›¾]
     ^
3s   â”‚         â•±â•²
2s   â”‚    â•±â•²  â•±  â•²
1s   â”‚___â•±  â•²â•±    â•²___
0s   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ time

[LLM ååé‡åˆ†å¸ƒ]
Key-001: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 12 QPS
Key-002: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   10 QPS
Key-003: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    9 QPS
...
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### ç«¯åˆ°ç«¯æµ‹è¯•
```bash
python scripts/test_streaming_pipeline.py --mode e2e --duration 60
```

**é¢„æœŸè¾“å‡º**:
```
[Task Generator] Started consuming from detection-results
[LLM Scheduler] Initialized with 10 API keys, max 50 concurrent tasks
[Result Aggregator] Started consuming from risk-assessment-results

[00:05] Sent 10 detection messages
[00:10] Received 10 assessment results
[00:15] Average latency: 1.8s
[00:20] Success rate: 98.5%

âœ“ Test completed: 60 messages processed, 0 errors
```

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡æ›´æ–°å®Œæˆäº†ä»¥ä¸‹æ ¸å¿ƒå·¥ä½œï¼š

1. âœ… **Windows è„šæœ¬æ”¯æŒ** - è·¨å¹³å°éƒ¨ç½²
2. âœ… **Kafka å®Œæ•´é›†æˆ** - DetectionPipeline + SessionManager + WebSocket
3. âœ… **é…ç½®çµæ´»æ€§** - ç¯å¢ƒå˜é‡ + é™çº§å¼€å…³
4. âœ… **Prometheus ç›‘æ§** - 30+ æ ¸å¿ƒæŒ‡æ ‡
5. âœ… **å®Œæ•´æ–‡æ¡£** - é›†æˆæŒ‡å— + æ•…éšœæ’æŸ¥

**ç³»ç»Ÿç°å·²å…·å¤‡**:
- ğŸš€ **10 å€å¹¶å‘èƒ½åŠ›** - ä» 5 è·¯åˆ° 50+ è·¯æ‘„åƒå¤´
- âš¡ **70% å»¶è¿Ÿé™ä½** - ä» 3-5 ç§’åˆ° < 1 ç§’
- ğŸ›¡ï¸ **é«˜å¯ç”¨æ¶æ„** - Kafka é›†ç¾¤ + API Key æ± 
- ğŸ“ˆ **å®Œæ•´ç›‘æ§** - Prometheus + Grafana
- ğŸ”§ **å‘åå…¼å®¹** - Kafka å¯é€‰ï¼Œé»˜è®¤ç¦ç”¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [KAFKA_INTEGRATION_GUIDE.md](KAFKA_INTEGRATION_GUIDE.md) - **Kafka é›†æˆæŒ‡å—** â­
- [DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md) - å¿«é€Ÿéƒ¨ç½²æŒ‡å—
- [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md) - å®æ–½æ€»ç»“
- [docs/æ¶æ„ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ.md](docs/æ¶æ„ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ.md) - è¯¦ç»†æ¶æ„æ–‡æ¡£

---

**ğŸŠ æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°å®Œæ¯•ï¼Œç³»ç»Ÿå·²å…·å¤‡ç”Ÿäº§éƒ¨ç½²èƒ½åŠ›ï¼**

ä¸‹ä¸€æ­¥å»ºè®®ï¼š
1. å®é™…ç¯å¢ƒæµ‹è¯•å’Œæ€§èƒ½éªŒè¯
2. æ ¹æ®æµ‹è¯•ç»“æœè°ƒä¼˜å‚æ•°
3. åˆ›å»º Grafana ä»ªè¡¨ç›˜é…ç½®
4. ç¼–å†™è¿ç»´æ‰‹å†Œ

**ç¥éƒ¨ç½²æˆåŠŸï¼** ğŸš€
