# æµå¤„ç†æ¶æ„åˆ†æ - Kafka Streaming vs Flink

## ğŸ“‹ ç›®å½•
- [å½“å‰æ¶æ„åˆ†æ](#å½“å‰æ¶æ„åˆ†æ)
- [Kafka Streaming æ˜¯ä»€ä¹ˆ](#kafka-streaming-æ˜¯ä»€ä¹ˆ)
- [Flink æµå¤„ç†æ˜¯ä»€ä¹ˆ](#flink-æµå¤„ç†æ˜¯ä»€ä¹ˆ)
- [ä¸¤è€…å¯¹æ¯”](#ä¸¤è€…å¯¹æ¯”)
- [é¡¹ç›®æ˜¯å¦éœ€è¦ Flink](#é¡¹ç›®æ˜¯å¦éœ€è¦-flink)
- [æ¶æ„ä¼˜åŒ–å»ºè®®](#æ¶æ„ä¼˜åŒ–å»ºè®®)

---

## å½“å‰æ¶æ„åˆ†æ

### ğŸ—ï¸ ç°æœ‰æµå¤„ç†æ¶æ„

ä½ çš„é¡¹ç›®**å·²ç»å®ç°äº†åŸºäº Kafka çš„æµå¤„ç†æ¶æ„**ï¼ŒåŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

#### 1. **æ•°æ®æµç®¡é“**
```
æ‘„åƒå¤´ RTSP æµ
    â†“
YOLO æ£€æµ‹ (Pipeline)
    â†“
Detection Results â†’ Kafka Topic: detection-results
    â†“
Task Generator (Consumer) â†’ ç”Ÿæˆ LLM ä»»åŠ¡
    â†“
Assessment Tasks â†’ Kafka Topic: assessment-tasks
    â†“
LLM Scheduler (Consumer) â†’ å¹¶å‘è°ƒç”¨ LLM API
    â†“
Risk Results â†’ Kafka Topic: risk-assessment-results
    â†“
Result Aggregator (Consumer) â†’ èšåˆç»“æœåˆ° Redis
    â†“
å‰ç«¯ WebSocket æ¨é€
```

#### 2. **æ ¸å¿ƒç»„ä»¶**

| ç»„ä»¶ | ç±»å‹ | åŠŸèƒ½ | å®ç°æ–¹å¼ |
|------|------|------|---------|
| **DetectionPipeline** | Producer | YOLO æ£€æµ‹ â†’ Kafka | åŒæ­¥æ¨é€æ£€æµ‹ç»“æœ |
| **SimpleTaskGenerator** | Consumer â†’ Producer | æ¶ˆè´¹æ£€æµ‹ç»“æœ â†’ ç”Ÿæˆä»»åŠ¡ | å•çº¿ç¨‹æ¶ˆè´¹ + åŒæ­¥å‘é€ |
| **LLMTaskScheduler** | Consumer â†’ Producer | æ¶ˆè´¹ä»»åŠ¡ â†’ å¹¶å‘è°ƒç”¨ LLM | **å¼‚æ­¥å¹¶å‘** (asyncio + ä¿¡å·é‡) |
| **ResultAggregator** | Consumer | æ¶ˆè´¹ LLM ç»“æœ â†’ Redis | å•çº¿ç¨‹æ¶ˆè´¹ + èšåˆ |

#### 3. **å¹¶å‘å¤„ç†èƒ½åŠ›**

**âœ… å·²å®ç°çš„å¹¶å‘æœºåˆ¶**ï¼š

```python
# algo/scheduler/task_scheduler.py
class LLMTaskScheduler:
    def __init__(self, max_concurrent_tasks: int = 50):
        # ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°
        self.semaphore = asyncio.Semaphore(max_concurrent_tasks)
        
    async def process_task(self, task: Dict[str, Any]):
        async with self.semaphore:  # é™åˆ¶å¹¶å‘æ•°
            api_key = self.key_pool.acquire_key(timeout=10.0)
            result = await self.call_llm_api(api_key, task)
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… **å¼‚æ­¥å¹¶å‘** - ä½¿ç”¨ `asyncio` + `aiohttp` å®ç°
- âœ… **å¹¶å‘é™åˆ¶** - ä¿¡å·é‡æ§åˆ¶æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°ï¼ˆé»˜è®¤ 50ï¼‰
- âœ… **API Key æ± ** - å¤š Key è½®è¯¢ï¼Œé¿å…å• Key é™æµ
- âœ… **èƒŒå‹æ§åˆ¶** - Kafka Consumer Group è‡ªåŠ¨ç®¡ç†æ¶ˆè´¹é€Ÿç‡

#### 4. **Prometheus ç›‘æ§**

**å·²é›†æˆçš„æŒ‡æ ‡**ï¼š
```python
# algo/monitoring/metrics.py
detection_total          # æ£€æµ‹æ€»æ•°
detection_latency        # æ£€æµ‹å»¶è¿Ÿ
llm_requests_total       # LLM è¯·æ±‚æ€»æ•°
llm_latency              # LLM å»¶è¿Ÿ
kafka_messages_sent      # Kafka æ¶ˆæ¯å‘é€æ•°
kafka_consumer_lag       # Kafka æ¶ˆè´¹å»¶è¿Ÿ
```

---

## Kafka Streaming æ˜¯ä»€ä¹ˆ

### ğŸ“¦ Kafka Streams

**Kafka Streams** æ˜¯ Apache Kafka æä¾›çš„**å®¢æˆ·ç«¯åº“**ï¼Œç”¨äºæ„å»ºæµå¤„ç†åº”ç”¨ã€‚

#### ç‰¹ç‚¹

1. **è½»é‡çº§** - ä½œä¸ºåº”ç”¨çš„ä¸€éƒ¨åˆ†è¿è¡Œï¼Œæ— éœ€ç‹¬ç«‹é›†ç¾¤
2. **æœ‰çŠ¶æ€å¤„ç†** - æ”¯æŒçª—å£ã€èšåˆã€Join ç­‰æ“ä½œ
3. **ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰** - Exactly-once processing
4. **å®¹é”™** - è‡ªåŠ¨æ•…éšœæ¢å¤å’Œå†å¹³è¡¡

#### ç¤ºä¾‹ä»£ç ï¼ˆJavaï¼‰

```java
StreamsBuilder builder = new StreamsBuilder();

// æ¶ˆè´¹æ£€æµ‹ç»“æœ
KStream<String, DetectionResult> detections = 
    builder.stream("detection-results");

// çª—å£èšåˆï¼šæ¯ 5 ç§’ç»Ÿè®¡æ£€æµ‹æ•°é‡
KTable<Windowed<String>, Long> counts = detections
    .groupByKey()
    .windowedBy(TimeWindows.of(Duration.ofSeconds(5)))
    .count();

// è¿‡æ»¤é«˜é£é™©
KStream<String, RiskResult> highRisk = detections
    .filter((key, value) -> value.riskLevel.equals("high"));

// è¾“å‡ºåˆ°æ–° Topic
highRisk.to("high-risk-alerts");
```

#### ä½ çš„é¡¹ç›®**æ²¡æœ‰ä½¿ç”¨** Kafka Streams

ä½ ä½¿ç”¨çš„æ˜¯ **confluent-kafka Python å®¢æˆ·ç«¯**ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„ Producer/Consumer åº“ï¼Œè€Œä¸æ˜¯ Kafka Streamsã€‚

---

## Flink æµå¤„ç†æ˜¯ä»€ä¹ˆ

### ğŸŒŠ Apache Flink

**Apache Flink** æ˜¯ä¸€ä¸ª**åˆ†å¸ƒå¼æµå¤„ç†æ¡†æ¶**ï¼Œä¸“ä¸ºå¤§è§„æ¨¡ã€ä½å»¶è¿Ÿçš„æ•°æ®æµå¤„ç†è®¾è®¡ã€‚

#### æ ¸å¿ƒæ¦‚å¿µ

1. **æ•°æ®æµå›¾** - DAG (Directed Acyclic Graph)
2. **ç®—å­é“¾** - Source â†’ Transformation â†’ Sink
3. **çŠ¶æ€ç®¡ç†** - åˆ†å¸ƒå¼ Checkpoint å’ŒçŠ¶æ€å­˜å‚¨
4. **äº‹ä»¶æ—¶é—´å¤„ç†** - åŸºäºäº‹ä»¶æ—¶é—´çš„çª—å£å’Œæ°´å°

#### æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flink JobManager â”‚ â† åè°ƒå™¨ï¼ˆé«˜å¯ç”¨ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚        â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â–¼â”€â”€â”€â”€â”
â”‚ Task  â”‚  â”‚ Task  â”‚  â”‚ Task â”‚ â† ä»»åŠ¡æ‰§è¡Œå™¨ï¼ˆå¹¶è¡Œï¼‰
â”‚Managerâ”‚  â”‚Managerâ”‚  â”‚Managerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
```

#### Flink ç¤ºä¾‹ä»£ç ï¼ˆJavaï¼‰

```java
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();

// æ¶ˆè´¹ Kafka
DataStream<DetectionResult> detections = env
    .addSource(new FlinkKafkaConsumer<>(
        "detection-results", 
        new DetectionResultSchema(), 
        kafkaProps
    ));

// çª—å£èšåˆï¼šæ¯ 1 åˆ†é’Ÿç»Ÿè®¡
DataStream<DetectionStats> stats = detections
    .keyBy(r -> r.cameraId)
    .window(TumblingEventTimeWindows.of(Time.minutes(1)))
    .aggregate(new DetectionAggregator());

// å¼‚æ­¥è°ƒç”¨ LLMï¼ˆå¹¶å‘æ§åˆ¶ï¼‰
DataStream<RiskResult> risks = detections
    .keyBy(r -> r.groupId)
    .asyncStream(new AsyncLLMFunction(), 30, TimeUnit.SECONDS)
    .setParallelism(50);  // 50 å¹¶å‘

// è¾“å‡ºåˆ° Kafka
risks.addSink(new FlinkKafkaProducer<>("risk-results", ...));

env.execute("Traffic Risk Analysis");
```

#### Flink çš„å¼ºå¤§åŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **çª—å£èšåˆ** | æ—¶é—´çª—å£ã€ä¼šè¯çª—å£ã€æ»‘åŠ¨çª—å£ | æ¯åˆ†é’Ÿç»Ÿè®¡æ£€æµ‹æ•°é‡ |
| **äº‹ä»¶æ—¶é—´** | åŸºäºäº‹ä»¶æ—¶é—´æˆ³ï¼Œè€Œéå¤„ç†æ—¶é—´ | å¤„ç†ä¹±åºæ•°æ®æµ |
| **çŠ¶æ€ç®¡ç†** | åˆ†å¸ƒå¼çŠ¶æ€å­˜å‚¨ + Checkpoint | ä¿å­˜ API Key çŠ¶æ€ |
| **èƒŒå‹å¤„ç†** | è‡ªåŠ¨è°ƒèŠ‚æ¶ˆè´¹é€Ÿç‡ | ä¸‹æ¸¸ LLM æ…¢æ—¶è‡ªåŠ¨é™é€Ÿ |
| **ç²¾ç¡®ä¸€æ¬¡** | Exactly-once semantics | é¿å…é‡å¤å¤„ç† |
| **å®¹é”™æ¢å¤** | Checkpoint + Savepoint | æ•…éšœæ¢å¤ä¸ä¸¢æ•°æ® |
| **åŠ¨æ€æ‰©ç¼©å®¹** | è¿è¡Œæ—¶è°ƒæ•´å¹¶è¡Œåº¦ | æ ¹æ®è´Ÿè½½è‡ªåŠ¨æ‰©å®¹ |

---

## ä¸¤è€…å¯¹æ¯”

### ğŸ“Š Kafka Streams vs Flink vs å½“å‰æ¶æ„

| ç‰¹æ€§ | **å½“å‰æ¶æ„**<br>(Python + Kafka Consumer) | **Kafka Streams**<br>(Java/Scala åº“) | **Apache Flink**<br>(åˆ†å¸ƒå¼æ¡†æ¶) |
|------|-----------------------------------|--------------------------|---------------------|
| **éƒ¨ç½²å¤æ‚åº¦** | â­ ç®€å• | â­â­ ä¸­ç­‰ | â­â­â­â­â­ å¤æ‚ |
| **è¿ç»´æˆæœ¬** | â­ ä½ | â­â­ ä¸­ç­‰ | â­â­â­â­ é«˜ |
| **å¹¶å‘èƒ½åŠ›** | âœ… 50 å¹¶å‘ (asyncio) | âœ… å¯æ‰©å±• | âœ…âœ… åˆ†å¸ƒå¼å¹¶å‘ |
| **çŠ¶æ€ç®¡ç†** | âŒ æ— ï¼ˆæ‰‹åŠ¨ Redisï¼‰ | âœ… æœ‰çŠ¶æ€ Store | âœ…âœ… åˆ†å¸ƒå¼çŠ¶æ€ |
| **çª—å£èšåˆ** | âŒ æ‰‹åŠ¨å®ç° | âœ… å†…ç½®çª—å£ | âœ…âœ… ä¸°å¯Œçª—å£ç±»å‹ |
| **å®¹é”™èƒ½åŠ›** | â­â­ ä¾èµ– Kafka | â­â­â­ è‡ªåŠ¨é‡å¯ | â­â­â­â­â­ Checkpoint |
| **å»¶è¿Ÿ** | â­â­â­ æ¯«ç§’çº§ | â­â­â­â­ æ¯«ç§’çº§ | â­â­â­â­â­ äºšç§’çº§ |
| **ååé‡** | â­â­â­ ä¸‡çº§/ç§’ | â­â­â­â­ åä¸‡çº§/ç§’ | â­â­â­â­â­ ç™¾ä¸‡çº§/ç§’ |
| **è¯­è¨€** | âœ… Python | âŒ Java/Scala | âŒ Java/Scala |
| **å­¦ä¹ æ›²çº¿** | â­ ä½ | â­â­â­ ä¸­ç­‰ | â­â­â­â­â­ é™¡å³­ |
| **ç¤¾åŒºæ”¯æŒ** | âœ… ä¸°å¯Œ | âœ… æˆç†Ÿ | âœ…âœ… æ´»è·ƒ |

### ğŸ¯ æ€§èƒ½å¯¹æ¯”ï¼ˆå®é™…åœºæ™¯ï¼‰

#### åœºæ™¯ï¼š10 è·¯æ‘„åƒå¤´ï¼Œæ¯ç§’ 1 å¸§æ£€æµ‹

| æŒ‡æ ‡ | å½“å‰æ¶æ„ | Kafka Streams | Flink |
|------|---------|--------------|-------|
| **æ£€æµ‹åå** | 10 FPS âœ… | 10 FPS âœ… | 10 FPS âœ… |
| **LLM å¹¶å‘** | 50 ä»»åŠ¡ âœ… | 50 ä»»åŠ¡ âœ… | 100+ ä»»åŠ¡ â­ |
| **ç«¯åˆ°ç«¯å»¶è¿Ÿ** | 1-3 ç§’ âœ… | 1-2 ç§’ â­ | 0.5-1 ç§’ â­â­ |
| **CPU ä½¿ç”¨** | ä½ âœ… | ä¸­ç­‰ | é«˜ âŒ |
| **å†…å­˜ä½¿ç”¨** | ä½ âœ… | ä¸­ç­‰ | é«˜ âŒ |
| **æ‰©å±•æ€§** | å‚ç›´æ‰©å±• | å‚ç›´æ‰©å±• | æ°´å¹³æ‰©å±• â­â­ |

---

## é¡¹ç›®æ˜¯å¦éœ€è¦ Flink

### âœ… **ç»“è®ºï¼šå½“å‰é˜¶æ®µ NOT NEEDED**

#### åŸå› åˆ†æ

##### 1. **å½“å‰æ¶æ„å·²è¶³å¤Ÿé«˜æ•ˆ**

ä½ çš„æ¶æ„å·²ç»å®ç°äº†å…³é”®ä¼˜åŒ–ï¼š

âœ… **å¼‚æ­¥å¹¶å‘å¤„ç†** - `LLMTaskScheduler` ä½¿ç”¨ `asyncio`ï¼Œæ”¯æŒ 50+ å¹¶å‘
âœ… **Kafka è§£è€¦** - Producer/Consumer è§£è€¦ï¼Œå¤©ç„¶æ”¯æŒèƒŒå‹
âœ… **API Key æ± ** - å¤š Key è½®è¯¢ï¼Œé¿å…å•ç‚¹é™æµ
âœ… **Prometheus ç›‘æ§** - å®Œæ•´çš„æŒ‡æ ‡ä½“ç³»
âœ… **å®¹é”™æœºåˆ¶** - Kafka Consumer Group è‡ªåŠ¨æ•…éšœæ¢å¤

##### 2. **æ€§èƒ½ç“¶é¢ˆä¸åœ¨æµå¤„ç†**

**çœŸå®ç“¶é¢ˆåˆ†æ**ï¼š

```
YOLO æ£€æµ‹: 50-200ms  â† å¯æ¥å—
  â†“
Kafka ä¼ è¾“: < 5ms    â† ä¸æ˜¯ç“¶é¢ˆ
  â†“
LLM API è°ƒç”¨: 2-10s  â† **çœŸæ­£çš„ç“¶é¢ˆ**
  â†“
ç»“æœèšåˆ: < 10ms     â† ä¸æ˜¯ç“¶é¢ˆ
```

**ç“¶é¢ˆæ˜¯ LLM API å»¶è¿Ÿï¼ˆ2-10ç§’ï¼‰ï¼Œè€Œä¸æ˜¯æµå¤„ç†æ¡†æ¶ï¼**

##### 3. **è§„æ¨¡è¯„ä¼°**

| åœºæ™¯ | å½“å‰æ¶æ„ | æ˜¯å¦éœ€è¦ Flink |
|------|---------|---------------|
| **10 è·¯æ‘„åƒå¤´** | âœ… è½»æ¾å¤„ç† | âŒ ä¸éœ€è¦ |
| **50 è·¯æ‘„åƒå¤´** | âœ… å¯å¤„ç† | âŒ ä¸éœ€è¦ |
| **100 è·¯æ‘„åƒå¤´** | âš ï¸ éœ€ä¼˜åŒ– | âš ï¸ å¯è€ƒè™‘ |
| **500+ è·¯æ‘„åƒå¤´** | âŒ ç“¶é¢ˆ | âœ… å»ºè®®ä½¿ç”¨ |

##### 4. **æˆæœ¬æ”¶ç›Šæ¯”**

**å¼•å…¥ Flink çš„æˆæœ¬**ï¼š
- âŒ å­¦ä¹ æ›²çº¿é™¡å³­ï¼ˆJava/Scalaï¼‰
- âŒ è¿ç»´å¤æ‚åº¦é«˜ï¼ˆJobManager + TaskManager + HDFS/S3ï¼‰
- âŒ èµ„æºæ¶ˆè€—å¤§ï¼ˆå†…å­˜ > 4GBï¼ŒCPU > 4 æ ¸ï¼‰
- âŒ å¼€å‘æ•ˆç‡é™ä½ï¼ˆPython â†’ Java é‡å†™ï¼‰

**æ”¶ç›Š**ï¼š
- âœ… æ›´å¥½çš„çª—å£èšåˆï¼ˆä½†ä½ å¯èƒ½ä¸éœ€è¦ï¼‰
- âœ… æ›´ä½çš„å»¶è¿Ÿï¼ˆä½†ç“¶é¢ˆåœ¨ LLM APIï¼‰
- âœ… æ›´é«˜çš„ååï¼ˆä½† 10 FPS è¿œæœªè¾¾åˆ°ç“¶é¢ˆï¼‰

**ROIï¼ˆæŠ•èµ„å›æŠ¥ç‡ï¼‰**: **ä½** âŒ

---

### ğŸš« ä¸å»ºè®®å¼•å…¥ Flink çš„åœºæ™¯

#### 1. **å°è§„æ¨¡éƒ¨ç½²**
- æ‘„åƒå¤´æ•°é‡ < 50 è·¯
- QPS < 100
- å•æœºéƒ¨ç½²

#### 2. **ç“¶é¢ˆåœ¨å¤–éƒ¨ API**
- ä½ çš„ç“¶é¢ˆæ˜¯ LLM API å»¶è¿Ÿï¼ˆ2-10ç§’ï¼‰
- å³ä½¿ Flink å»¶è¿Ÿé™åˆ° 100msï¼Œç«¯åˆ°ç«¯å»¶è¿Ÿä»æ˜¯ 2-10ç§’

#### 3. **å›¢é˜ŸæŠ€èƒ½æ ˆ**
- å›¢é˜Ÿæ“…é•¿ Python
- æ²¡æœ‰ Java/Scala ä¸“å®¶
- è¿ç»´èƒ½åŠ›æœ‰é™

#### 4. **ä¸šåŠ¡éœ€æ±‚**
- ä¸éœ€è¦å¤æ‚çš„çª—å£èšåˆï¼ˆå¦‚ 1 åˆ†é’Ÿç»Ÿè®¡ï¼‰
- ä¸éœ€è¦ Join å¤šæµæ•°æ®
- ä¸éœ€è¦äº‹ä»¶æ—¶é—´å¤„ç†ï¼ˆä¹±åºæ•°æ®ï¼‰

---

### âœ… å»ºè®®å¼•å…¥ Flink çš„åœºæ™¯

#### 1. **å¤§è§„æ¨¡éƒ¨ç½²**
- æ‘„åƒå¤´æ•°é‡ > 100 è·¯
- QPS > 1000
- åˆ†å¸ƒå¼éƒ¨ç½²

#### 2. **å¤æ‚æµå¤„ç†éœ€æ±‚**
- **çª—å£èšåˆ** - æ¯åˆ†é’Ÿç»Ÿè®¡æ£€æµ‹æ•°é‡ã€è½¦æµé‡è¶‹åŠ¿
- **å¤šæµ Join** - å…³è”æ£€æµ‹æµ + è½¦ç‰Œè¯†åˆ«æµ + äº¤é€šä¿¡å·ç¯æµ
- **CEPï¼ˆå¤æ‚äº‹ä»¶å¤„ç†ï¼‰** - æ£€æµ‹ "è¿ç»­ 3 æ¬¡é—¯çº¢ç¯" æ¨¡å¼
- **äº‹ä»¶æ—¶é—´å¤„ç†** - å¤„ç†ä¹±åºæ•°æ®æµï¼ˆç½‘ç»œå»¶è¿Ÿå¯¼è‡´ï¼‰

#### 3. **é«˜å¯ç”¨è¦æ±‚**
- 7Ã—24 å°æ—¶ä¸é—´æ–­è¿è¡Œ
- æ•…éšœæ¢å¤æ—¶é—´ < 1 åˆ†é’Ÿ
- æ•°æ®é›¶ä¸¢å¤±

#### 4. **æŠ€æœ¯å‚¨å¤‡**
- å›¢é˜Ÿæœ‰ Java/Scala ä¸“å®¶
- æœ‰ Flink è¿ç»´ç»éªŒ
- æœ‰å……è¶³çš„åŸºç¡€è®¾æ–½ï¼ˆKubernetesã€HDFS/S3ï¼‰

---

## æ¶æ„ä¼˜åŒ–å»ºè®®

### ğŸ¯ åŸºäºå½“å‰æ¶æ„çš„ä¼˜åŒ–æ–¹æ¡ˆ

#### ä¼˜åŒ– 1: **å¢åŠ  LLM å¹¶å‘åº¦**

**å½“å‰é…ç½®**ï¼š
```python
# algo/scheduler/task_scheduler.py
max_concurrent_tasks = 50  # é»˜è®¤ 50 å¹¶å‘
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```python
max_concurrent_tasks = 100  # æé«˜åˆ° 100 å¹¶å‘

# é…åˆæ›´å¤š API Key
api_keys = [
    "key_1", "key_2", "key_3", ..., "key_10"  # 10 ä¸ª Key
]
```

**æ•ˆæœ**ï¼š
- ååé‡æå‡ 2 å€
- LLM å»¶è¿Ÿä¸å˜
- æˆæœ¬ï¼šå¢åŠ  API Key æ•°é‡

#### ä¼˜åŒ– 2: **æ‰¹é‡å¤„ç†**

**å½“å‰æµç¨‹**ï¼š
```
1 ä¸ªæ£€æµ‹ç»“æœ â†’ ç”Ÿæˆ N ä¸ªä»»åŠ¡ â†’ é€ä¸ªè°ƒç”¨ LLM
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```python
# æ‰¹é‡è°ƒç”¨ LLMï¼ˆå¦‚æœ API æ”¯æŒï¼‰
async def call_llm_batch(api_key, tasks: List[Dict]) -> List[Dict]:
    # ä¸€æ¬¡è¯·æ±‚å¤„ç†å¤šä¸ªç¾¤ç»„
    payload = {
        "model": "qwen-vl-plus-batch",  # å‡è®¾æœ‰æ‰¹é‡æ¥å£
        "requests": [build_request(task) for task in tasks]
    }
    # ...
```

**æ•ˆæœ**ï¼š
- å‡å°‘ç½‘ç»œå¼€é”€
- æé«˜ API åˆ©ç”¨ç‡
- **å‰æï¼šLLM API æ”¯æŒæ‰¹é‡è¯·æ±‚**

#### ä¼˜åŒ– 3: **æ™ºèƒ½è¿‡æ»¤**

**å½“å‰é€»è¾‘**ï¼š
```python
# æ‰€æœ‰ç¾¤ç»„éƒ½ç”Ÿæˆä»»åŠ¡
for group_image in group_images:
    task = generate_task(group_image)
    send_to_kafka(task)
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```python
# åªå¯¹"å¯èƒ½æœ‰é£é™©"çš„ç¾¤ç»„ç”Ÿæˆä»»åŠ¡
for group_image in group_images:
    # é¢„è¿‡æ»¤ï¼šè½¦è¾†æ•°é‡ >= 2 æˆ–æœ‰è¡Œäºº
    if has_potential_risk(group_image):
        task = generate_task(group_image)
        send_to_kafka(task)
    else:
        # ç›´æ¥è¿”å› "æ— é£é™©"
        send_safe_result(group_image)
```

**æ•ˆæœ**ï¼š
- å‡å°‘ LLM è°ƒç”¨æ¬¡æ•° 50-70%
- é™ä½æˆæœ¬
- å»¶è¿Ÿä¸å˜

#### ä¼˜åŒ– 4: **ç¼“å­˜ç»“æœ**

**æ–¹æ¡ˆ**ï¼š
```python
# ä½¿ç”¨ Redis ç¼“å­˜ç›¸ä¼¼åœºæ™¯çš„ç»“æœ
def get_cached_result(group_image_hash: str) -> Optional[Dict]:
    return redis.get(f"llm_result:{group_image_hash}")

def cache_result(group_image_hash: str, result: Dict, ttl: int = 300):
    redis.setex(f"llm_result:{group_image_hash}", ttl, json.dumps(result))

# åœ¨è°ƒç”¨ LLM å‰æ£€æŸ¥ç¼“å­˜
cached = get_cached_result(image_hash)
if cached:
    return cached
else:
    result = await call_llm_api(...)
    cache_result(image_hash, result)
    return result
```

**æ•ˆæœ**ï¼š
- ç¼“å­˜å‘½ä¸­ç‡ 20-40%
- é™ä½ LLM æˆæœ¬
- å»¶è¿Ÿé™ä½ 90%ï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰

#### ä¼˜åŒ– 5: **åˆ†çº§å¤„ç†**

**æ–¹æ¡ˆ**ï¼š
```python
# æ ¹æ®é£é™©ç­‰çº§åˆ†é…ä¸åŒçš„å¤„ç†ç­–ç•¥
class RiskLevelRouter:
    def route_task(self, detection: Dict) -> str:
        if is_high_risk_pattern(detection):
            return "high-priority-topic"  # ä¼˜å…ˆå¤„ç†ï¼Œæ›´å¤šèµ„æº
        elif is_medium_risk_pattern(detection):
            return "medium-priority-topic"
        else:
            return "low-priority-topic"  # å»¶è¿Ÿå¤„ç†ï¼Œé™ä½æˆæœ¬
```

**æ•ˆæœ**ï¼š
- é«˜é£é™©åœºæ™¯å®æ—¶å¤„ç†
- ä½é£é™©åœºæ™¯æ‰¹é‡å¤„ç†
- èµ„æºåˆ©ç”¨ç‡æé«˜

---

### ğŸ”® æœªæ¥æ¶æ„æ¼”è¿›è·¯å¾„

#### é˜¶æ®µ 1: å½“å‰æ¶æ„ï¼ˆâœ… å·²å®Œæˆï¼‰
```
Python + Kafka Consumer/Producer + asyncio å¹¶å‘
è§„æ¨¡: 10-50 è·¯æ‘„åƒå¤´
```

#### é˜¶æ®µ 2: ä¼˜åŒ–å½“å‰æ¶æ„ï¼ˆğŸ¯ æ¨èï¼‰
```
+ å¢åŠ å¹¶å‘åº¦ï¼ˆ100+ï¼‰
+ æ™ºèƒ½è¿‡æ»¤
+ ç»“æœç¼“å­˜
+ åˆ†çº§å¤„ç†
è§„æ¨¡: 50-100 è·¯æ‘„åƒå¤´
```

#### é˜¶æ®µ 3: å¼•å…¥è½»é‡çº§æµå¤„ç†ï¼ˆå¯é€‰ï¼‰
```
+ Kafka Streamsï¼ˆçª—å£èšåˆï¼‰
+ ä¿ç•™ Python æ ¸å¿ƒé€»è¾‘
+ æ··åˆæ¶æ„
è§„æ¨¡: 100-300 è·¯æ‘„åƒå¤´
```

#### é˜¶æ®µ 4: å…¨é¢ Flinkï¼ˆä»…åœ¨å¿…è¦æ—¶ï¼‰
```
+ Apache Flink
+ é‡å†™ä¸º Java/Scala
+ åˆ†å¸ƒå¼éƒ¨ç½²
è§„æ¨¡: 300+ è·¯æ‘„åƒå¤´ï¼Œå¤æ‚æµå¤„ç†
```

---

## æ€»ç»“

### âœ… å½“å‰æ¶æ„è¯„ä»·

| æ–¹é¢ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **è®¾è®¡åˆç†æ€§** | â­â­â­â­â­ | ä½¿ç”¨ Kafka è§£è€¦ï¼Œå¼‚æ­¥å¹¶å‘ï¼Œè®¾è®¡ä¼˜ç§€ |
| **å¯æ‰©å±•æ€§** | â­â­â­â­ | æ”¯æŒå‚ç›´æ‰©å±•ï¼Œæ°´å¹³æ‰©å±•éœ€æ”¹é€  |
| **æ€§èƒ½** | â­â­â­â­ | æ»¡è¶³å½“å‰éœ€æ±‚ï¼ˆ10-50 è·¯æ‘„åƒå¤´ï¼‰ |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­â­ | Python ä»£ç æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤ |
| **æˆæœ¬** | â­â­â­â­â­ | èµ„æºæ¶ˆè€—ä½ï¼Œè¿ç»´ç®€å• |

### ğŸ¯ æ ¸å¿ƒå»ºè®®

1. **âœ… ä¿æŒå½“å‰æ¶æ„** - ä¸å»ºè®®å¼•å…¥ Flink
2. **â­ ä¼˜åŒ–å¹¶å‘åº¦** - æé«˜åˆ° 100+ å¹¶å‘
3. **â­ æ™ºèƒ½è¿‡æ»¤** - å‡å°‘ä¸å¿…è¦çš„ LLM è°ƒç”¨
4. **â­ ç»“æœç¼“å­˜** - ä½¿ç”¨ Redis ç¼“å­˜ç›¸ä¼¼åœºæ™¯
5. **â­ åˆ†çº§å¤„ç†** - é«˜é£é™©ä¼˜å…ˆï¼Œä½é£é™©å»¶è¿Ÿ

### ğŸ“Š æ€§èƒ½é¢„æœŸ

**ä¼˜åŒ–å‰**ï¼š
- åå: 10 FPS Ã— 10 è·¯ = 100 FPS
- å»¶è¿Ÿ: 2-10 ç§’ï¼ˆLLM APIï¼‰
- å¹¶å‘: 50 ä»»åŠ¡

**ä¼˜åŒ–å**ï¼š
- åå: **æå‡ 2-3 å€**ï¼ˆå¹¶å‘ + æ‰¹é‡ï¼‰
- å»¶è¿Ÿ: **é™ä½ 50%**ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- å¹¶å‘: 100 ä»»åŠ¡
- æˆæœ¬: **é™ä½ 30-50%**ï¼ˆæ™ºèƒ½è¿‡æ»¤ + ç¼“å­˜ï¼‰

### ğŸ’¡ ä½•æ—¶è€ƒè™‘ Flink

**è§¦å‘æ¡ä»¶ï¼ˆæ»¡è¶³ä»»æ„ 2 é¡¹ï¼‰**ï¼š
- âœ… æ‘„åƒå¤´æ•°é‡ > 100 è·¯
- âœ… éœ€è¦å¤æ‚çª—å£èšåˆï¼ˆå¦‚ 1 åˆ†é’Ÿç»Ÿè®¡ï¼‰
- âœ… éœ€è¦å¤šæµ Joinï¼ˆæ£€æµ‹ + è½¦ç‰Œ + ä¿¡å·ç¯ï¼‰
- âœ… éœ€è¦ CEPï¼ˆå¤æ‚äº‹ä»¶æ¨¡å¼æ£€æµ‹ï¼‰
- âœ… æœ‰ Java/Scala ä¸“å®¶å›¢é˜Ÿ

**åœ¨æ­¤ä¹‹å‰ï¼Œä¼˜åŒ–å½“å‰æ¶æ„å³å¯ï¼** âœ…

---

**ç»“è®ºï¼šä½ çš„æ¶æ„è®¾è®¡ä¼˜ç§€ï¼Œå½“å‰ä¸éœ€è¦ Flinkï¼Œé€šè¿‡ä¼˜åŒ–å¹¶å‘ã€ç¼“å­˜å’Œè¿‡æ»¤å³å¯æ»¡è¶³æœªæ¥æ‰©å±•éœ€æ±‚ã€‚** ğŸ‰
