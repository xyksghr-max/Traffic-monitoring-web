## **需求文档：实时危险画面检测系统并发处理能力优化**

### **1. 需求名称**

基于 Flink、Kafka 及多 API Key 调度的实时危险画面检测系统并发能力优化

### **2. 背景与目标**

- **当前状况 (Current State):**
  - 项目当前流程为：摄像头实时视频流 -> YOLO 目标检测 -> BX 聚类形成群组 -> 将群组图片发给多模态大模型进行风险评估。
  - 整个流程中，对多模态大模型的 API 调用是核心且耗时的步骤。
  - 目前系统仅使用单个 API Key 调用大模型服务，该模型的 QPS（每秒查询率）或 RPM（每分钟请求数）存在上限，这严重限制了系统的整体并发处理能力。当视频源增加或画面中目标群组增多时，请求会因 API 速率限制而堆积或失败，导致检测延迟增高，失去实时性。
- **需求目标 (Objective):**
  - **核心目标：** 大幅提升系统的并发处理能力和吞吐量，支持更多路摄像头的同时检测，并降低端到端的处理延迟。
  - **技术目标：**
    1. 引入分布式消息队列（Kafka）实现系统各模块间的解耦，增强系统的稳定性和扩展性。
    2. 引入流处理引擎（Flink）对检测数据进行实时处理、聚合和任务分发。
    3. 构建一个支持多 API Key 的任务调度器，通过 API Key 池化技术轮询或分配调用任务，突破单 Key 的速率限制。
    4. 建立一个更具弹性和容错性的系统架构。

### **3. 需求范围与详细说明 (Scope & Details)**

本次需求主要包含以下几个核心模块的开发和集成：

#### **3.1. 引入 Kafka 消息队列**

- **功能描述：** 建立 Kafka 消息管道，用于解耦上游的“检测/聚类模块”和下游的“风险评估模块”。
- **具体任务：**
  - 创建至少两个核心 Topic：
    - `detection-results-topic`：用于接收 YOLO 和 BX 聚类后的结果。消息内容应包含：`摄像头ID`、`时间戳`、`群组图片数据 (或图片存储地址)`、`群组元数据 (如坐标、人数等)`。
    - `risk-assessment-results-topic`：用于存放多模态大模型返回的风险评估结果。消息内容应包含：`原始请求ID`、`摄像头ID`、`风险等级`、`风险描述`、`时间戳`。
  - 上游的检测服务（YOLO+BX）需要改造为生产者（Producer），将处理后的群组信息发送到 `detection-results-topic`。

#### **3.2. 引入 Flink 流处理引擎**

- **功能描述：** Flink 作为系统的实时计算核心，消费上游数据，并为调用大模型准备任务。
- **具体任务：**
  - 创建一个 Flink 作业，作为消费者（Consumer）从 `detection-results-topic` 读取数据。
  - Flink 作业可以进行一些轻量级的流式处理，例如：
    - **数据转换：** 将消息格式化为调用大模型 API 所需的格式。
    - **任务生成：** 为每一个需要评估的群组图片生成一个唯一的“评估任务”。
    - **任务分发：** 将生成的评估任务发送给下一步的“任务调度器”。（可以通过 RPC 调用或再推送到一个新的 Kafka Topic `assessment-tasks-topic`）。

#### **3.3. 构建任务调度器与 API Key 池化模块**

- **功能描述：** 这是解决并发瓶颈的核心模块。它负责管理一个 API Key 池，并将 Flink 生成的评估任务高效地分配出去。
- **具体任务：**
  - **API Key 管理：**
    - 系统应支持在配置中动态增、删、改多个多模态大模型的 API Key。
    - 需要有一个 API Key 池，维护所有 Key 的当前状态（如：可用、正在使用、暂时因速率限制而冷却）。
  - **任务调度逻辑：**
    - 调度器接收来自 Flink 的评估任务。
    - 从 API Key 池中获取一个“可用”的 Key。调度策略可以是轮询（Round-robin）、随机或基于当前负载最低的 Key。
    - 使用获取到的 Key，异步调用多模态大模型的 API。
    - 实现调用失败的重试机制（例如，因网络问题或 Key 临时失效）。如果一个 Key 因速率限制失败，应将其标记为“冷却”状态，在一段时间内不再使用。
  - **结果回传：**
    - 在获得大模型的返回结果后，将结果（成功或失败信息）作为生产者发送到 `risk-assessment-results-topic`。

#### **3.4. 结果消费与处理**

- **功能描述：** 系统的下游模块（如告警服务、数据看板、数据库存储服务等）消费最终的评估结果。
- **具体任务：**
  - 创建一个或多个消费者服务，订阅 `risk-assessment-results-topic`。
  - 根据消费到的风险等级，执行相应的业务逻辑，如：发送告警通知、更新监控仪表盘、将结果持久化存储等。

### **4. 建议架构图**

```
[摄像头] -> [YOLO检测服务] -> [BX聚类] -> Kafka Producer
                                             |
                                             v
                                  [Kafka: detection-results-topic]
                                             |
                                             v
[Flink 流处理作业 (消费、转换、生成任务)] -> [任务调度器 (管理API Key池, 并发调用大模型)]
                                             |                     ^
                                             |                     | (获取可用Key)
                                             |                     v
                                             |              [API Key Pool]
                                             |              (Key1, Key2, Key3, ...)
                                             v
                                  [调用多模态大模型 API]
                                             |
                                             v
                                       Kafka Producer
                                             |
                                             v
                               [Kafka: risk-assessment-results-topic]
                                             |
                                             v
                                [下游消费服务 (告警/存储/展示)]
```

### **5. 非功能性需求 (Non-Functional Requirements)**

- **性能：** 引入新架构后，系统应能支持至少 [例如: 50] 路摄像头的并发处理，端到端延迟（从画面捕捉到输出风险评估结果）应控制在 [例如: 2秒] 以内。
- **可扩展性：**
  - 系统应支持水平扩展。当处理能力不足时，可以通过增加 Flink 任务的并行度、增加任务调度器实例或增加 Kafka 分区来提升性能。
  - API Key 池应支持动态扩容，无需重启服务。
- **高可用性：**
  - 利用 Kafka 的多副本机制和 Flink 的 Checkpoint/Savepoint 机制，确保消息不丢失，服务可在故障后恢复。
  - 任务调度器应具备容错能力，单个 API Key 失效不应影响整个系统的运行。
- **可监控性：** 关键节点需要提供监控指标，如 Kafka Topic 的消息积压量（Lag）、Flink 的吞吐量、API Key 的调用成功率和失败率等，以便进行性能分析和故障排查。

### **6. 验收标准 (Acceptance Criteria)**

1. 所有模块（Kafka, Flink, 任务调度器）成功部署并集成到现有流程中。
2. YOLO+BX 的检测结果能够正确地被生产到指定的 Kafka Topic。
3. Flink 作业能够正确消费数据，并触发任务调度器。
4. 任务调度器能够使用配置文件中的所有 API Key 并发地调用大模型服务。可以通过日志或监控验证请求被均匀（或按策略）分配。
5. 在模拟高并发场景下（例如，使用压测工具模拟大量消息涌入），系统不会因为单 Key 速率限制而崩溃或产生大量错误，整体处理能力相较于旧版有明显提升（例如，吞吐量提升 N 倍）。
6. 禁用其中一个 API Key 后，系统应能自动切换到其他可用 Key，不中断服务。

------